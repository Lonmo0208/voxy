#version 460 core
//Uses intrinsics and other operations to perform very fast sorting
// we dont need a propper sort, only a fuzzy sort, as in we only need to top 128 entries, but those can be unsorted

//#define OUTPUT_SIZE 128

layout(local_size_x=128, local_size_y=1) in;
//256 workgroup

#import <voxy:lod/hierarchical/node.glsl>

layout(binding = VISIBILITY_BUFFER_BINDING, std430) restrict readonly buffer VisibilityDataBuffer {
    uint[] visiblity;
};

layout(binding = OUTPUT_BUFFER_BINDING, std430) restrict volatile buffer MinimumVisibilityBuffer {//TODO: might need to be volatile
    uint minVisIds[OUTPUT_SIZE];
};

//Returns the id of the max value
uint atomicDerefMin(uint atId, uint id, uint value) {
    uint existingId = minVisIds[atId];
    while (true) {
        //Check if the value is less than the dereferenced value, if its not, return our own id
        if (visiblity[existingId] <= value) {
            return id;
        }
        //Attempt to swap, since we know we are less than the existingId
        atomicCompSwap(minVisIds[atId], existingId, id);
        //Check if we did swap, else if we failed (or got reswapped else where) recheck
        uint pExistingId = existingId;
        existingId = minVisIds[atId];
        if (existingId == id) {
            return pExistingId;
        }
    }
}

//TODO: optimize
void bubbleSort(uint start, uint id, uint value) {
    for (uint i = start; i < OUTPUT_SIZE; i++) {
        uint nextId = atomicDerefMin(i, id, value);
        //Else we need to bubble the value up
        id = nextId;
        value = visiblity[id];
    }
}

void main() {
    //if (gl_GlobalInvocationID.x <64) {
    //    minVisIds[gl_GlobalInvocationID.x] = visiblity[gl_GlobalInvocationID.x];
    //}
    //First do a min sort/set of min OUTPUT_SIZE values of the set
    uint vis = visiblity[gl_GlobalInvocationID.x];
    if (visiblity[minVisIds[OUTPUT_SIZE-1]] <= vis) {
        return;
    }
    UnpackedNode node;
    unpackNode(node, gl_GlobalInvocationID.x);
    if (isEmptyMesh(node) || (!hasMesh(node)) || (!hasChildren(node))) {
        return;
    }
    bubbleSort(0, gl_GlobalInvocationID.x, vis);
}